"""
@crontab: 00,30 * * * * cd ${BASE_PATH} && python -m finance.news_ai_explain.py 2>&1 | tee -a news_ai_explain.log
"""

from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
import json, sys

from dotenv import load_dotenv, dotenv_values
import requests
import openai

from pyutils.notify_util import Feishu, Pushme
from pyutils.date_util import now_time, now


def get_start_end_time():
    nowtime = now_time()
    now_hm = nowtime.strftime('%H:%M')
    dt = nowtime.strftime('%Y-%m-%d')
    dt_1 = (nowtime - timedelta(days=1)).strftime('%Y-%m-%d')

    map_dict = {
        "09:30": (f"{dt} 00:00:00", f"{dt} 09:30:00"),
        "11:30": (f"{dt} 09:30:00", f"{dt} 11:30:00"),
        "13:00": (f"{dt} 11:30:00", f"{dt} 13:00:00"),
        "15:00": (f"{dt} 13:00:00", f"{dt} 15:00:00"),
        "18:00": (f"{dt} 15:00:00", f"{dt} 18:00:00"),
        "21:00": (f"{dt} 18:00:00", f"{dt} 21:00:00"),
        "24:00": (f"{dt_1} 21:00:00", f"{dt_1} 24:00:00"),
        "00:00": (f"{dt_1} 21:00:00", f"{dt_1} 24:00:00"),
    }
    return map_dict[now_hm] if now_hm in map_dict else ((nowtime-timedelta(hours=3)).strftime('%Y-%m-%d %H:%M:%S'), '9999-12-31 23:59:59')


if __name__ == '__main__':
    config = dotenv_values(".env")
    news_api = 'https://newsapi.eastmoney.com/kuaixun/v1/getlist_102_ajaxResult_100_1_.html'  # æœ€æ–°100æ¡
    ua_headers = {'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1 Edg/143.0.0.0'}

    # æ–°é—»æ—¶é—´èŒƒå›´ï¼Œé¿å…å¤šæ¬¡è¿è¡Œé‡å¤
    start_time, end_time = get_start_end_time()
    now_str = now('%Y-%m-%d %H:%M')
    if '9999' in end_time and 'onlytime' in ''.join(sys.argv):
        sys.exit(0)

    # æŠ“å–ä¸œè´¢7x24å°æ—¶çš„æœ€æ–°Næ¡ï¼Œå¹¶æŒ‰æ—¶é—´è¿‡æ»¤
    resp = requests.get(news_api, headers=ua_headers)
    data = json.loads(resp.text.split('=', 1)[-1])
    LivesList = data['LivesList']; print(f'len(LivesList) = {len(LivesList)}')

    filter_LivesList = [{key:one[key] for key in ('showtime','title','digest')} for one in LivesList if start_time<=one['showtime']<end_time]  # url_unique
    news_json = json.dumps(filter_LivesList, ensure_ascii=False, separators=(',',':'));print(news_json)  # ç´§å¯†è¾“å‡º
    real_start, real_end = min([x['showtime'] for x in filter_LivesList]), max([x['showtime'] for x in filter_LivesList])


    # AIæ€»ç»“
    client = openai.OpenAI(api_key=config['OPENAI_API_KEY'], base_url=config['OPENAI_BASE_URL'])
    completion = client.chat.completions.create(
        #ä»¥æ­¤å¤„ä¸ºä¾‹ï¼Œè¯·ç¡®ä¿æ›¿æ¢ä¸ºä½ å®é™…åœ¨ build.nvidia.com é€‰æ‹©çš„æ¨¡å‹åç§°
        model=config['OPENAI_MODEL_ID'],
        messages=[
            {"role": "system", "content": "ä½ æ˜¯è´¢ç»æ–°é—»è§£è¯»å’Œä¸ªäººæŠ•èµ„å»ºè®®åŠ©æ‰‹ã€‚é˜…è¯»ä¸‹é¢å†…å®¹ï¼Œåˆ†ç±»æ–°é—»ï¼ŒæŒ‰é‡è¦æ€§æ’åºï¼Œå¹¶è§£è¯»æ¯ä¸ªæ–°é—»çš„å†…åœ¨é€»è¾‘ã€å¸‚åœºå½±å“å’Œå¯¹ä¸ªäººæŠ•èµ„è€…çš„æŠ•èµ„å½±å“"},
            {"role": "user", "content": news_json}
        ],
        temperature=0.7,
        top_p=0.95,
        max_tokens=65535,
        stream=False # å¼€å¯æµå¼è¾“å‡º
    )
    news_ai_explain = completion.choices[0].message.content; print(news_ai_explain); print(completion.usage)

    # é£ä¹¦é€šçŸ¥
    title = f"è´¢ç»æ–°é—»è§£è¯»({now_str})"
    footer = f'ğŸ¤– Generated by AI\n{start_time} ~ {end_time}\n{real_start} ~ {real_end}'

    try:
        Feishu(config['FEISHU_WEBHOOK_TOKEN']).send_markdown(title, news_ai_explain, footer=footer)
    finally:
        Pushme(config['PUSHME_PUSH_KEY']).send_markdown('[#7x24å°æ—¶è´¢ç»æ–°é—»!ğŸ“œ]'+title, news_ai_explain)

